#include "fsl_i2c.h"
#include "CharConvert.h"
/*
const uint8_t SPL06_002=0x78;
The SPL06-002 device 7-bits address is 0x78*/

#include <stdio.h>
#include "stdint.h"
#include "fsl_i2c.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "sensor.h"
#include "globalParams.h"
#include "userConfig.h"
#include "flashLayout.h"
#define OLED_I2C_ADDR   0x3D


struct spl0601_calib_param_t {
	int16_t c0;
	int16_t c1;
	int32_t c00;
	int32_t c10;
	int16_t c01;
	int16_t c11;
	int16_t c20;
	int16_t c21;
	int16_t c30;
};

struct spl0601_t {
    struct spl0601_calib_param_t calib_param;/**<calibration data*/
    uint8_t chip_id; /**<chip id*/
    int32_t i32rawPressure;
    int32_t i32rawTemperature;
    int32_t i32kP;
    int32_t i32kT;
};


extern void delay_30ms(void);
extern void delay_s(void);
extern _ARMABI int printf(const char * __restrict /*format*/, ...) __attribute__((__nonnull__(1)));
extern void OLED_ShowStr(unsigned char x,unsigned char y,unsigned char *chr);
extern float x, y, z;
extern int	UVA_data, UVB_data;
extern int lx;
extern uint32_t persure;
extern float temp, hum;
extern int red, green, blue;

const uint8_t SPL06_001 = 0x77;
/*The SPL06-001 device 7-bits address is 0x77*/

static struct spl0601_t spl0601;

static struct spl0601_t *p_spl0601;

void OLED_ShowChar(unsigned char x, unsigned char y, unsigned char chr);
void OLED_Set_Pos(unsigned char x, unsigned char y);
const unsigned char F8X16[] =
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00,
  0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00,
  0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00,
  0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00,
  0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10,
  0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,
  0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00,
  0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00,
  0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00,
  0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,
  0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
  0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,
  0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,
  0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,
  0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,
  0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,
  0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,
  0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,
  0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,
  0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,
  0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00,
  0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00,
  0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,
  0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00,
  0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00,
  0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00,
  0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,
  0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,
  0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,
  0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,
  0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,
  0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,
  0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,
  0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,
  0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
  0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,
  0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,
  0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,
  0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,
  0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,
  0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,
  0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,
  0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,
  0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,
  0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,
  0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,
  0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,
  0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,
  0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,
  0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,
  0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,
  0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,
  0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,
  0x00,0x0C,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xC0,0x00,
  0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,
  0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
  0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20,
  0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00,
  0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00,
  0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20,
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00,
  0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x18,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
  0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00,
  0x08,0xF8,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,
  0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
  0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,
  0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00,
  0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,
  0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F,
  0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,
  0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00,
  0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0x20,0xA0,0xFF,0x80,
  0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00,
  0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00,
  0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00,
  0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20,
  0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00,
  0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00,
  0x00,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00,
  0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x8E,0x70,0x18,0x06,0x01,0x00,
  0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00,
  0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40,
  0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
  0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00,
  0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void OLED_Set_Pos(unsigned char x, unsigned char y)
{
	uint8_t Set_Pos[6]={0x80,0x00,0x80,0x00,0x00,0x00};
	Set_Pos[1] = 0xB0+y;
	Set_Pos[3] = ((x&0xf0)>>4)|0x10;
	Set_Pos[5] = (x&0x0f);
	I2C_Write_polling(I2C0, OLED_I2C_ADDR, Set_Pos, 6);
}

void API_OLED_Clear(void)
{
	unsigned char i;
	uint8_t zero[256] = {0};

	for(i=0; i<253; i=i+2)
	{
		zero[i] = 0xC0;             /* command      */
		zero[i+1] = 0x00;             /* value = ' '  */
	}

	zero[254] = 0x40;                     /* End command  */

	for(i=0; i<8; i++)
	{
			OLED_Set_Pos(0, i);
			I2C_Write_polling(I2C0, OLED_I2C_ADDR, zero, 256);
	}
}

void OLED_init(void)
{
	/*  Variables */
	uint8_t OLED_Init_Reg[56]={0x80,0xAE,0x80,0x00,0x80,0x10,0x80,0x40,0x80,0x81,0x80,0xCF,0x80,0xA1,0x80,0xC8,0x80,0xA6,0x80,0xA8,0x80,0x3f,0x80,0xD3,0x80,0x00,0x80,0xd5,0x80,0x80,0x80,0xD9,0x80,0xF1,0x80,0xDA,0x80,0x12,0x80,0xDB,0x80,0x40,0x80,0x20,0x80,0x02,0x80,0x8D,0x80,0x14,0x80,0xA4,0x80,0xA6,0x00,0xAF};

	/* OLED_Init_Reg */
	int size = sizeof(OLED_Init_Reg);
	I2C_Write_polling(I2C0, OLED_I2C_ADDR, OLED_Init_Reg, size);
  API_OLED_Clear();
}

void OLED_ShowChar(unsigned char x,unsigned char y,unsigned char chr)
{
    unsigned char c=0, i=0;
    uint8_t ShowChar[16];
    for(i=0; i<13; i=i+2)
		{
    	ShowChar[i] = 0xC0;
    }
    ShowChar[14] = 0x40;

    c = chr-' ';
    if(x>128-1)   
		{
			x = 0;
			y = y+2;
		}

    /* font , Line 1st  */
    OLED_Set_Pos(x, y);
    for(i=0; i<8; i++)
		{
      ShowChar[(2*i)+1] = F8X16[c*16+(i)];
    }
		I2C_Write_polling(I2C0, OLED_I2C_ADDR, ShowChar, 16);
		
    /* font , Line 2nd  */
    OLED_Set_Pos(x, y+1);
    for(i=0; i<8; i++)
		{
      ShowChar[(2*i)+1] = F8X16[c*16+(i)+8];
    }
		I2C_Write_polling(I2C0, OLED_I2C_ADDR, ShowChar, 16);
}

/* String length , Max = 16 */
void OLED_ShowStr(unsigned char x, unsigned char y, unsigned char *chr)
{
    unsigned char j;
    j = 0;
  
    while (chr[j] != '\0')
    {	
        if(x>120)
            break;
        
        OLED_ShowChar(x, y, chr[j]);
        x += 8;
        j++;
    }
}

int16_t c0, c1, c01, c11, c20, c21, c30;
int32_t c00, c10;
uint32_t spl0601_get_pressure(void)
{

	uint32_t fTsc, fPsc;
	int32_t qua2, qua3;
	uint32_t fPCompensate;

	int32_t arithmetic;

	fTsc = (p_spl0601->i32kT>>16);
  fTsc = p_spl0601->i32rawTemperature / (int32_t)fTsc;

	fPsc = (p_spl0601->i32kP>>16);
  fPsc = p_spl0601->i32rawPressure / (int32_t)fPsc;

	arithmetic = c30;
  if(arithmetic<0)
	{
    arithmetic = (arithmetic>>16)|0xFFFF0000;
  }
	else
	{
    arithmetic = arithmetic>>16;
  }

  arithmetic = arithmetic+c20;

  arithmetic = fPsc*arithmetic;

  if(arithmetic<0)
	{
    arithmetic = (arithmetic>>16)|0xFFFF0000;
  }
	else
	{
    arithmetic = arithmetic>>16;
  }

  arithmetic = arithmetic+c10;

  arithmetic = arithmetic*fPsc;
  if(arithmetic<0)
	{
    arithmetic = (arithmetic>>16)|0xFFFF0000;
  }
	else
	{
    arithmetic = arithmetic>>16;
  }
  qua2 = arithmetic;

	arithmetic = fPsc * c21;
	if(arithmetic<0)
	{
		arithmetic = (arithmetic>>16)|0xFFFF0000;
	}
	else
	{
		arithmetic = arithmetic>>16;
	}
	arithmetic = arithmetic+c11;
	arithmetic = arithmetic*fPsc;
	if(arithmetic<0)
	{
		arithmetic = (arithmetic>>16)|0xFFFF0000;
	}
	else
	{
		arithmetic = arithmetic>>16;
	}
	arithmetic = arithmetic*fTsc;
	if(arithmetic<0)
	{
		arithmetic = (arithmetic>>16)|0xFFFF0000;
	}
	else
	{
		arithmetic = arithmetic>>16;
	}
	qua3 = arithmetic;

	arithmetic = fTsc * c01;
	if(arithmetic<0)
	{
		arithmetic = (arithmetic>>16)|0xFFFF0000;
	}
	else
	{
		arithmetic = arithmetic>>16;
	}
	fPCompensate =  arithmetic + qua3 + c00 + qua2;
	return fPCompensate;
}

uint32_t spl0601_get_temperature(void)
{
	uint32_t fTCompensate;
	uint32_t fTsc;

	fTsc =  (p_spl0601->i32kT>>16);
	fTsc = p_spl0601->i32rawTemperature/fTsc;

	fTCompensate = (c0<<15)+(c1 * fTsc);

	return  fTCompensate;
}

void spl0601_get_raw_pressure(void)
{
		uint8_t h, m, l;
    uint8_t read_data[3];
    const uint8_t PRS_B2 = 0x00;
    /*PRS_B2 The Highest of the three bytes measured pressure value. address=0x00 */
		I2C_Readdata(I2C0, 0x77, PRS_B2, read_data, 3);

    h = read_data[0];
    m = read_data[1];
    l = read_data[2];

    p_spl0601->i32rawPressure = (int32_t)h<<16 | (int32_t)m<<8 | (int32_t)l;

    if((p_spl0601->i32rawPressure&0x800000) == 0x800000)
		{
    	 p_spl0601->i32rawPressure = (0xFF000000|p_spl0601->i32rawPressure);
    }
}

void spl0601_get_raw_temp(void)
{
    uint8_t h, m, l;

    uint8_t read_data[3];
    const uint8_t TMP_B2 = 0x03;
    /*TMP_B2 The Highest of the three bytes measured temperature value. address=0x03 */
//    write_data[0]=TMP_B2;
		I2C_Readdata(I2C0, 0x77, TMP_B2, read_data, 3);

    h = read_data[0];
    m = read_data[1];
    l = read_data[2];

    p_spl0601->i32rawTemperature = (int32_t)h<<16 | (int32_t)m<<8 | (int32_t)l;

    if((p_spl0601->i32rawTemperature&0x800000) == 0x800000)
		{
    	p_spl0601->i32rawTemperature = (0xFF000000|p_spl0601->i32rawTemperature);
    }
}

void spl0601_rateset(uint8_t iSensor, uint8_t u8SmplRate, uint8_t u8OverSmpl)
{
    uint8_t reg = 0;
    int32_t i32kPkT = 0;
#if 0
    switch(u8SmplRate)
    {
        case 2:
            reg |= (1<<4);
            break;
        case 4:
            reg |= (2<<4);
            break;
        case 8:
            reg |= (3<<4);
            break;
        case 16:
            reg |= (4<<4);
            break;
        case 32:
            reg |= (5<<4);
            break;
        case 64:
            reg |= (6<<4);
            break;
        case 128:
            reg |= (7<<4);
            break;
        case 1:
        default:
            break;
    }
    switch(u8OverSmpl)
    {
        case 2:
            reg |= 1;
            i32kPkT = 1572864;
            break;
        case 4:
            reg |= 2;
            i32kPkT = 3670016;
            break;
        case 8:
            reg |= 3;
            i32kPkT = 7864320;
            break;
        case 16:
            i32kPkT = 253952;
            reg |= 4;
            break;
        case 32:
            i32kPkT = 516096;
            reg |= 5;
            break;
        case 64:
            i32kPkT = 1040384;
            reg |= 6;
            break;
        case 128:
            i32kPkT = 2088960;
            reg |= 7;
            break;
        case 1:
        default:
            i32kPkT = 524288;
            break;
    }
#endif
    reg |= (5<<4);
    reg |= 3;
    i32kPkT = 7864320;
    if(iSensor == 0)
    {
        p_spl0601->i32kP = i32kPkT;
				I2C_WriteByte(I2C0, 0x77, 0x06, reg);
        if(u8OverSmpl > 8)
        {
						I2C_Readdata(I2C0, 0x77, 0x09, &reg, 1);
						I2C_WriteByte(I2C0, 0x77, 0x09, reg | 0x04);
        }
    }

    if(iSensor == 1)
    {
        p_spl0601->i32kT = i32kPkT;
				//Using mems temperature
        reg=reg|0x80;
				I2C_WriteByte(I2C0, 0x77, 0x07, reg);
        if(u8OverSmpl > 8)
        {
						I2C_Readdata(I2C0, 0x77, 0x09, &reg, 1);
						I2C_WriteByte(I2C0, 0x77, 0x09, reg | 0x08);
        }
    }
}

void spl0601_init(void)
{
    p_spl0601 = &spl0601; /* read Chip Id */
    p_spl0601->i32rawPressure = 0;
    p_spl0601->i32rawTemperature = 0;
    p_spl0601->chip_id = 0x34;
    spl0601_get_calib_param();
    /* sampling rate = 1Hz; Pressure oversample = 2;*/
    spl0601_rateset(PRESSURE_SENSOR,32, 8);
    /* sampling rate = 1Hz; Temperature oversample = 1;*/
    spl0601_rateset(TEMPERATURE_SENSOR,32, 8);
    /*Start background measurement*/
}	

void spl0601_get_calib_param(void)
{
		uint8_t coef[18];
		I2C_Readdata(I2C0, 0x77, 0x10, coef, 18);
		c0 = (int16_t) ((coef[0]<<4) | (coef[1]>>4) );
    c0 = (c0&0x0800)?(0xF000|c0):c0;
    c1 = (int16_t)(coef[1]&0x0F)<<8 | coef[2];
    c1 = (c1&0x0800)?(0xF000|c1):c1;
    c00 = (int32_t)coef[3]<<12 | (int32_t)coef[4]<<4 | (int32_t)coef[5]>>4;
    if((c00&0x080000) == 0x080000)
		{
    	 c00 = (0xFFF00000|c00);
    }
    c10 = (int32_t)coef[5]<<16 | (int32_t)coef[6]<<8 | coef[7];
    if((c10&0x080000) == 0x080000)
		{
    	c10 = (0xFFF00000|c10);
    }
    c01 = (int16_t)coef[8]<<8 | coef[9];
    c11 = (int16_t)coef[10]<<8 | coef[11];
    c20 = (int16_t)coef[12]<<8 | coef[13];
    c21 = (int16_t)coef[14]<<8 | coef[15];
    c30 = (int16_t)coef[16]<<8 | coef[17];
}

uint16_t SPL06_001_init(void)
{
	uint16_t temp;

	const uint8_t MEAS_CFG = 0x08;

	const uint8_t MEAS_CFG_value = 0x07;

	uint8_t data_write[2] = {MEAS_CFG,MEAS_CFG_value};

  spl0601_init();

	temp = I2C_WriteByte(I2C0, 0x77, data_write[0], data_write[1]);

//	delay_30ms();
	return  temp;

}

//extern uint32_t persure;
void SPL06_001_Value(void)
{
//	delay_30ms();
	char Pdata[16];
	spl0601_get_raw_pressure();	
	persure = spl0601_get_pressure();
	printf("pressure = %d\r\n", persure);
	sprintf(Pdata, "%.0f hPa", (float)persure/100);
	OLED_ShowStr(24,3,(uint8_t*)Pdata);
}

void OLED_Welcome(void)
{
	char *UserID = "UserID = ";
	char *DeviceID = "DeviceID = ";
	char *MAC_ADDRESS = "MAC_ADDRESS:";
	char userId[10];
	char deviceId[10];
	char mac[16];
	char* cdata = (char*)VERSION_STR_ADDRESS;
	btcInfo.userID = cdata[12];
	btcInfo.deviceID = cdata[13];
	sprintf(userId,"%d",btcInfo.userID);
	sprintf(deviceId,"%d",btcInfo.deviceID);
	sprintf(mac,"%02x%02x%02x%02x%02x%02x",btcInfo.mac[0],btcInfo.mac[1],btcInfo.mac[2],btcInfo.mac[3],btcInfo.mac[4],btcInfo.mac[5]);
//	printf("%02x%02x%02x%02x%02x%02x\n\r",loginInfo.MAC_ADD[0],loginInfo.MAC_ADD[1],loginInfo.MAC_ADD[2],loginInfo.MAC_ADD[3],loginInfo.MAC_ADD[4],loginInfo.MAC_ADD[5]);
	API_OLED_Clear();
	OLED_ShowStr(0, 0, (uint8_t*)UserID);
	OLED_ShowStr(72, 0, (uint8_t*)userId);
	OLED_ShowStr(0, 2, (uint8_t*)DeviceID);
	OLED_ShowStr(88, 2, (uint8_t*)deviceId);
	OLED_ShowStr(0, 4, (uint8_t*)MAC_ADDRESS);
	OLED_ShowStr(0, 6, (uint8_t*)mac);
}

void HDC1050_Init(void)
{	
	I2C_WriteByte(I2C0, 0x40, 0x02, 0x10);
}
void HDC1050_Show(void)
{
	API_OLED_Clear();
	char *TH = "T&H";
	char *T = "T:      C";
	char *H = "H:      %";
	OLED_ShowStr(0, 0, (uint8_t*)TH);
	OLED_ShowStr(0, 3, (uint8_t*)T);
	OLED_ShowStr(0, 6, (uint8_t*)H);
}
void HDC1050_Run(void)
{
	uint8_t buf_TH[4];//T&H Sensor
	char Tdata[16];
	char Hdata[16];
	memset(Tdata, 0, sizeof(Tdata));
	memset(Hdata, 0, sizeof(Hdata));
	//T
	I2C_Readdata(I2C0, 0x40, 0x00, buf_TH, 2);
	temp = buf_TH[0]*256+buf_TH[1];
	temp = temp/65536*165-40;
//	printf(" Temperature is %d\r\n", temp);
	//H
	I2C_Readdata(I2C0, 0x40, 0x01, buf_TH, 2);
	hum = buf_TH[0]*256+buf_TH[1];
	hum = hum/65536*100; 
//	printf(" Humidity is %2.2f\r\n", hum);
//	sprintf(Tdata, "%2.2f", temp);	
//	OLED_ShowStr(24, 3, (uint8_t*)Tdata);
//	sprintf(Hdata, "%2.2f", hum);
//	OLED_ShowStr(24, 6, (uint8_t*)Hdata);
}

void RGB_Init(void)
{
	I2C_WriteByte(I2C0, 0X38, 0x38, 1);
	// clear RGB
	I2C_WriteByte(I2C0, 0X38, (0x00), 1);
	
}
void RGB_Show(void)
{
	API_OLED_Clear();
	char *RGB = "RGB Running";
	OLED_ShowStr(0, 2, (uint8_t*)RGB);
}
void RGB_Run(int red, int green, int blue)
{
	I2C_WriteByte(I2C0, 0X38, (0x40+(int)(red>>3)), 1);
	I2C_WriteByte(I2C0, 0X38, (0x60+(int)(green>>3)), 1);
	I2C_WriteByte(I2C0, 0X38, (0x80+(int)(blue>>3)), 1);	
//	delay_s();
}

void SPL06001_Init(void)
{
	spl0601_get_calib_param();
	delay_30ms();
	//config
	SPL06_001_init();
}
void SPL06001_Show(void)
{
	API_OLED_Clear();
	char *Pressure = "Pressure";
	char *P = "P: ";
	OLED_ShowStr(0, 0, (uint8_t*)Pressure);
	OLED_ShowStr(0, 3, (uint8_t*)P);
}
void SPL06001_Run(void)
{
	//è¯» persure				
	SPL06_001_Value();
}

void VEML6030_Init(void)
{	
	I2C_WriteByte(I2C0, 0x48, 0x00, 0x0000);
}
void VEML6030_Show(void)
{
	API_OLED_Clear();
	char *L = "ALS";	
	OLED_ShowStr(0, 0, (uint8_t*)L);
	L = "lux: ";
	OLED_ShowStr(0, 3, (uint8_t*)L);
}
void VEML6030_Run(void)
{
	uint8_t ALS[2];
	uint16_t ALS_data;
//	char Ldata[16];

	I2C_Readdata(I2C0, 0x48, 0x04, ALS, 2);
	ALS_data = (ALS[1]<<8)+ALS[0];
	const uint8_t SENSITIVITY=24; /*SENSITIVITY = 0.042 (lx/bit)  1/0.042 = 24*/
	lx = ALS_data/SENSITIVITY/10;
//	printf("lx = %d\r\n",lx);
//	sprintf(Ldata, "%d", lx);
//	OLED_ShowStr(40, 3, (uint8_t*)Ldata);
}

void VEML6075_Init(void)
{	
	I2C_WriteByte(I2C0, 0x10, 0x00, 0x40);
}
void VEML6075_Show(void)
{
	API_OLED_Clear();
	char *UV = "UV";
	char *UA = "UVA: ";
	char *UB = "UVB: ";
	OLED_ShowStr(0, 0, (uint8_t*)UV);
	OLED_ShowStr(0, 3, (uint8_t*)UA);
	OLED_ShowStr(0, 6, (uint8_t*)UB);
}
void VEML6075_Run(void)
{
	uint8_t UVA[2], UVB[2];
//	char UVAdata[16];
//	char UVBdata[16];
	I2C_Readdata(I2C0, 0x10, 0x07, UVA, 2);
	UVA_data = ((UVA[1]<<8)+UVA[0]);
	I2C_Readdata(I2C0, 0x10, 0x09, UVB, 2);
	UVB_data = ((UVB[1]<<8)+UVB[0]);
//	sprintf(UVAdata, "%d", (float)UVA_data);
//	sprintf(UVBdata, "%d", (float)UVB_data);
//	OLED_ShowStr(40, 3, (uint8_t*)UVAdata);
//	OLED_ShowStr(40, 6, (uint8_t*)UVBdata);
}

void ADXL345_Init(void)
{	
	I2C_WriteByte(I2C0, 0x1D, 0x2D, 0x0A);
	I2C_WriteByte(I2C0, 0x1D, 0x31, 0x0B);
}
void ADXL345_Show(void)
{
	API_OLED_Clear();
	char *G = "G";
	OLED_ShowStr(0, 0, (uint8_t*)G);
	G = "Qx: ";
	OLED_ShowStr(0, 2, (uint8_t*)G);
	G = "Ty: ";
	OLED_ShowStr(0, 4, (uint8_t*)G);
	G = "Kz: ";
	OLED_ShowStr(0, 6, (uint8_t*)G);
}
void ADXL345_Run(void)
{
	uint8_t buf_G[8];//G-Sensor	
	char Xdata[16];
	char Ydata[16];
	char Zdata[16];
	int16_t x0, y0, z0;
	I2C_Readdata(I2C0, 0x1D, 0x32, &buf_G[0], 1);
	I2C_Readdata(I2C0, 0x1D, 0x33, &buf_G[1], 1);
	I2C_Readdata(I2C0, 0x1D, 0x34, &buf_G[2], 1);
	I2C_Readdata(I2C0, 0x1D, 0x35, &buf_G[3], 1);
	I2C_Readdata(I2C0, 0x1D, 0x36, &buf_G[4], 1);
	I2C_Readdata(I2C0, 0x1D, 0x37, &buf_G[5], 1);
	x0 = (buf_G[1]<<8)|buf_G[0];
	y0 = (buf_G[3]<<8)|buf_G[2];
	z0 = (buf_G[5]<<8)|buf_G[4];
printf(" x:%d, y:%d, z:%d\r\n", x0, y0, z0);
	x = x0 * 4 ;
	y = y0 * 4 ;
	z = z0 * 4 ;
//	x = x0;
//	y = y0;
//	z = z0;	
//	x = atan(x/(sqrt(z*z)+sqrt(y*y))) * 180/3.14;
//	y = atan(y/(sqrt(x*x)+sqrt(z*z))) * 180/3.14;
//	z = atan(z/(sqrt(x*x)+sqrt(y*y)))*180/3.14;

//	printf(" x:%f , y:%f , z:%f \r\n", x, y, z);

	sprintf(Xdata, "%.0f", x);
	sprintf(Ydata, "%.0f", y);
	sprintf(Zdata, "%.0f", z);
	OLED_ShowStr(32, 2, (uint8_t*)Xdata);
	OLED_ShowStr(32, 4, (uint8_t*)Ydata);
	OLED_ShowStr(32, 6, (uint8_t*)Zdata);
}

void sensorInit(void)
{
	HDC1050_Init();
	RGB_Init();
	SPL06001_Init();
	VEML6075_Init();
	VEML6030_Init();
	ADXL345_Init();
	OLED_init();
	delay_30ms();
	OLED_Welcome();	
}
